/*===========================================================================
  AN4_balanced_panel.do
  Purpose : Address Reviewer 2, Comment 1 — clarify MCBS panel structure and
            compute the "balanced panel" subsample (beneficiaries with at least
            one pre-2020 AND at least one post-2020 survey observation).
  Data    : MCBS_PUF_all_years.dta (Dropbox/data_clean/)
  Output  : (1) Printed table of panel structure counts (pre/post observations
                per beneficiary)
            (2) Robustness check: main DiD restricted to balanced-panel
                subsample
  Author  : Generated by /draft-responses for revision responses
  Date    : 2026-02-23
===========================================================================*/

* ── Preamble ──────────────────────────────────────────────────────────────
clear all
set more off
set linesize 120

* Set path to data
global DATA "C:/Users/xc77/Dropbox/data_clean"
global OUT  "C:/Users/xc77/my-rr-agent/output"

cap mkdir "$OUT"

use "$DATA/MCBS_PUF_all_years.dta", clear

* ── STEP 1: Describe MCBS panel structure ─────────────────────────────────
* Confirm the ID variable name (likely baseid, bene_id, or id)
* EDIT the variable name below if different in your data:
local id_var  "baseid"       // ← EDIT if your beneficiary ID has a different name
local yr_var  "year"          // ← EDIT if year variable has a different name

* Count observations per beneficiary
bysort `id_var': gen n_obs = _N

* Create pre/post indicators
gen pre2020  = (`yr_var' < 2020)
gen post2020 = (`yr_var' >= 2020)

* Count pre and post observations per beneficiary
bysort `id_var': egen n_pre  = total(pre2020)
bysort `id_var': egen n_post = total(post2020)

* Flag balanced-panel beneficiaries (at least 1 pre AND 1 post)
gen balanced = (n_pre >= 1 & n_post >= 1)

* ── TABLE A: Panel structure summary ──────────────────────────────────────
di ""
di "=== TABLE A: MCBS Panel Structure (all beneficiaries) ==="
tab n_obs, missing

di ""
di "=== TABLE B: Number of pre-2020 observations per beneficiary ==="
tab n_pre, missing

di ""
di "=== TABLE C: Number of post-2020 observations per beneficiary ==="
tab n_post, missing

di ""
di "=== TABLE D: Balanced-panel beneficiaries ==="
di "  (at least 1 pre-2020 AND at least 1 post-2020 observation)"
tab balanced, missing

* ── STEP 2: Restrict to main analytical sample ────────────────────────────
* Apply the same sample restrictions as the main analysis
* EDIT variable names below to match your dataset:

/*
  Key variables to confirm:
    - ma_full    : indicator for full-year MA enrollment (=1 if enrolled full year)
    - adrd       : indicator for ADRD diagnosis (self-reported)
    - control    : indicator for control group (stroke/paralysis/PD, no ADRD)
    - veteran    : indicator for veteran status
    - Outcome vars: access_trouble, fin_burden, satisfy_specialist, satisfy_quality
    - Covariates : age_cat*, female, married*, race_*, edu_cat*,
                   hhsize_cat*, bmi_cat*, iadl_adl_cat*, ncc_cat*,
                   proxy (self-respondent indicator)
*/

* Keep MA full-year enrollees, non-veterans, in treatment or control group
keep if ma_full == 1
keep if veteran == 0
keep if adrd == 1 | control == 1

* ── TABLE E: Balanced-panel status in analytical sample ───────────────────
di ""
di "=== TABLE E: Balanced-panel status in analytical sample ==="
tab balanced adrd, row col missing

di ""
di "=== TABLE F: Balanced-panel N by treatment group ==="
bysort adrd: tab balanced, missing

* ── STEP 3: Main DiD — full analytical sample (replication check) ─────────
* This replicates the main Table 3 / Figure 3 result for verification

di ""
di "=== REPLICATION: Main DiD (full analytical sample) ==="

gen treated = adrd  // treatment indicator
gen post    = (`yr_var' >= 2020)  // post indicator
gen treated_post = treated * post

* Outcome loop
foreach outcome in access_trouble fin_burden satisfy_specialist satisfy_quality {
    cap confirm var `outcome'
    if _rc {
        di "WARNING: Variable `outcome' not found — skip"
        continue
    }
    di ""
    di "--- Outcome: `outcome' ---"
    * Main DiD with year FE and covariate × year interactions
    * NOTE: Adjust covariate list to match your actual variable names
    regress `outcome' treated_post treated post ///
        i.`yr_var' ///
        c.age_cont#i.`yr_var' ///
        i.female#i.`yr_var' ///
        i.race_cat#i.`yr_var' ///
        i.edu_cat#i.`yr_var' ///
        i.iadl_adl_cat#i.`yr_var' ///
        i.ncc_cat#i.`yr_var' ///
        i.bmi_cat#i.`yr_var' ///
        i.proxy#i.`yr_var' ///
        , robust
    di "  treated_post coef = " _b[treated_post] ///
       "  SE = " _se[treated_post] ///
       "  N = " e(N)
}

* ── STEP 4: Robustness — Balanced panel subsample ─────────────────────────
di ""
di "=== ROBUSTNESS: DiD restricted to balanced-panel subsample ==="
di "    (beneficiaries with >=1 pre-2020 AND >=1 post-2020 observation)"

preserve
keep if balanced == 1

di ""
di "Balanced-panel N by treatment group:"
tab adrd, missing

foreach outcome in access_trouble fin_burden satisfy_specialist satisfy_quality {
    cap confirm var `outcome'
    if _rc {
        di "WARNING: Variable `outcome' not found — skip"
        continue
    }
    di ""
    di "--- Outcome: `outcome' (balanced panel) ---"
    regress `outcome' treated_post treated post ///
        i.`yr_var' ///
        c.age_cont#i.`yr_var' ///
        i.female#i.`yr_var' ///
        i.race_cat#i.`yr_var' ///
        i.edu_cat#i.`yr_var' ///
        i.iadl_adl_cat#i.`yr_var' ///
        i.bmi_cat#i.`yr_var' ///
        i.iadl_adl_cat#i.`yr_var' ///
        i.ncc_cat#i.`yr_var' ///
        i.proxy#i.`yr_var' ///
        , robust
    di "  treated_post coef = " _b[treated_post] ///
       "  SE = " _se[treated_post] ///
       "  N = " e(N)
}

restore

* ── STEP 5: Confirm event study uses all respondents ──────────────────────
* The event study (Figure 4 / eMethods 2) uses the full analytical sample
* (not restricted to balanced-panel). This note confirms that for the Methods.

di ""
di "=== NOTE for eMethods 2 revision ==="
di "The event study uses all respondents in the analytical sample."
di "Beneficiaries contribute observations only in years they are surveyed."
di "The 2019 reference year includes all respondents observed in 2019."
di "This is a standard two-way FE event study design — not a balanced panel."
di ""
di "For the Methods clarification:"
count if `yr_var' == 2019 & adrd == 1
di "  ADRD beneficiaries observed in reference year 2019: " r(N)
count if `yr_var' == 2019 & control == 1
di "  Control beneficiaries observed in reference year 2019: " r(N)

log close _all
